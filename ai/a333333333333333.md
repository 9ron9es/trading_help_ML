# Trading System Architecture Documentation

## System Overview
A multi-asset automated trading system supporting Crypto, Stocks, and Forex with real-time data streams, machine learning predictions, and comprehensive risk management.

## File Structure Map
```
main.py
├── DATA_LAYER (Lines 1-800)
│   ├── Configuration & Constants
│   ├── WebSocket Managers
│   ├── CSV Data Handlers
│   └── API Clients
├── ML_ENGINE (Lines 801-1200)
│   ├── Technical Indicators
│   ├── Model Training
│   └── Signal Generation
├── RISK_MANAGEMENT (Lines 1201-1400)
│   ├── AdvancedRiskManager
│   ├── TradingCircuitBreaker
│   └── Position Sizing
├── TRADING_ENGINE (Lines 1401-1800)
│   ├── Trade Execution
│   ├── Exit Management
│   └── Order Handling
└── MONITORING (Lines 1801-2100)
    ├── Dashboard
    ├── Performance Monitor
    └── Health Checks
```

## Detailed Component Analysis

### 1. CONFIGURATION & CONSTANTS (Lines 1-84)

**TRADING_HOURS**
- Defines market hours for stocks (9:30-16:00), forex (24/5), crypto (24/7)

**RISK_PARAMS**
- max_daily_loss_percent: 2.0%
- max_total_drawdown_percent: 15.0%
- max_consecutive_losses: 3
- max_daily_trades: 10
- position_size_percent: 1.0%

**API Configuration**
- Binance API keys for crypto data
- NewsAPI for sentiment analysis
- HuggingFace token for ML models

**Trading Parameters**
- ACCOUNT_BALANCE_START: $10,000
- RISK_PER_TRADE: 1%
- REWARD_RISK_RATIO: 2.0
- ATR_MULTIPLIER_SL: 1.5
- MIN_SL_PIPS: 10

### 2. CORE MANAGER CLASSES

#### AdvancedRiskManager (Lines 85-150)
**Purpose**: Comprehensive pre-trade risk validation and position management

**Key Methods**:
- pre_trade_checks(): Validates 5 risk conditions before trade execution
- update_trade_result(): Updates risk metrics after trade closure
- reset_daily(): Resets daily counters at market open

**Risk Checks**:
1. Daily loss limit (2% of account)
2. Maximum account drawdown (15% from start)
3. Consecutive losses (max 3)
4. Daily trade limit (max 10)
5. Minimum stop loss validation

#### TradingCircuitBreaker (Lines 152-300)
**Purpose**: Market condition monitoring and emergency trading controls

**Key Methods**:
- market_condition_check(): Validates 4 market safety conditions
- emergency_stop_trading(): Immediate halt of all trading activity
- _close_all_positions(): Emergency closure of open positions

**Safety Checks**:
1. Volatility spike detection using ATR
2. Major economic news events
3. Market liquidity validation
4. Data quality verification

### 3. DATA STREAM MANAGERS

#### start_crypto_stream() (Lines 350-450)
**Purpose**: Real-time cryptocurrency data via Binance WebSocket

**Data Flow**:
1. Connects to Binance Kline streams for 8 major pairs
2. Handles WebSocket messages with error recovery
3. Saves to crypto.csv with OHLCV data
4. Fallback to dummy data if API unavailable

#### start_forex_stream() (Lines 470-550)
**Purpose**: Forex data collection via ExchangeRate API

**Data Flow**:
1. Fetches 10 major forex pairs every 5 minutes
2. Includes pip values and currency names
3. Robust error handling with fallback data
4. Saves to forex.csv with timestamp

### 4. SENTIMENT ANALYSIS ENGINE (Lines 600-850)

#### refresh_sentiment() (Lines 750-800)
**Purpose**: Market sentiment analysis from news headlines

**Process**:
1. Fetches articles for 18 financial queries
2. Cleans and processes text content
3. Applies ensemble sentiment analysis (VADER + TextBlob)
4. Detects asset mentions in articles
5. Calculates market sentiment metrics

**Sentiment Features**:
- Enhanced VADER with financial lexicon
- TextBlob with context awareness
- Ensemble weighting based on confidence
- Asset-specific sentiment tracking

### 5. MACHINE LEARNING ENGINE

#### train_model_from_data() (Lines 950-1020)
**Purpose**: Online learning with River framework

**Process**:
1. Loads historical data for each asset type
2. Applies 13 technical indicators
3. Merges with daily sentiment scores
4. Trains LogisticRegression with StandardScaler
5. Creates binary classification (price up/down)

**Technical Indicators**:
- RSI, MACD, SMA50, EMA20
- ADX, ATR, OBV, CMF
- Volume-based indicators
- Sentiment score integration

#### generate_signal() (Lines 1070-1150)
**Purpose**: Generate trading signals with risk parameters

**Logic**:
- BUY signal: prob_up > 0.6
- SELL signal: prob_down > 0.6
- Stop Loss: 1.5 x ATR
- Take Profit: 3.0 x ATR (2:1 reward:risk)
- Position size based on risk percentage

### 6. TRADE EXECUTION ENGINE

#### execute_trade() (Lines 1400-1470)
**Purpose**: Safe trade execution with comprehensive validation

**Execution Flow**:
1. Circuit breaker check
2. Risk manager validation
3. Position size calculation
4. Trade record creation
5. Alert notification

#### check_trade_exits() (Lines 1500-1600)
**Purpose**: Monitor open positions for TP/SL hits

**Exit Logic**:
- Real-time price monitoring
- P&L calculation per asset type
- Balance and statistics updates
- Trade history recording

### 7. POSITION SIZING SYSTEM

#### calculate_position_size() (Lines 1170-1220)
**Purpose**: Risk-adjusted position sizing

**Calculation Methods**:
- **Forex**: Lot size based on pip risk
- **Stocks/Crypto**: Share quantity based on dollar risk
- **Volatility Adjustment**: Reduces size during high volatility
- **Affordability Check**: Caps at maximum affordable quantity

### 8. MONITORING & DASHBOARD

#### display_dashboard() (Lines 1800-1900)
**Purpose**: Real-time system monitoring interface

**Dashboard Sections**:
- Live prices (last 2 hours)
- Sentiment analysis (last 7 days)
- Trading signals with probabilities
- Account summary and trade history
- Open positions and recent closures

#### PerformanceMonitor (Lines 1950-2050)
**Purpose**: Comprehensive performance analytics

**Metrics Tracked**:
- Win rate and profit factor
- Average win/loss amounts
- Maximum drawdown calculation
- Daily trading statistics
- Risk-adjusted returns

### 9. MAIN EXECUTION LOOP

#### enhanced_main_loop() (Lines 2050-2150)
**Purpose**: Core system orchestration

**Execution Sequence**:
1. System health check
2. Market condition validation
3. Data collection and processing
4. Model retraining (if needed)
5. Signal generation and execution
6. Position monitoring and exits
7. Dashboard updates
8. Performance reporting

## Data Flow Visualization

```
External APIs
    ↓
[Data Streams] → CSV Storage → Technical Analysis
    ↓
Sentiment Analysis → Feature Engineering
    ↓
[ML Models] → Signal Generation → Risk Validation
    ↓
Trade Execution → Position Management
    ↓
Performance Monitoring → Dashboard Display
```

## Critical Integration Points

1. **WebSocket → CSV**: Real-time data persistence
2. **CSV → TA**: Technical indicator calculation
3. **TA + Sentiment → ML**: Feature preparation
4. **ML → Risk Manager**: Signal validation
5. **Risk Manager → Execution**: Safe trade placement
6. **Execution → Monitoring**: Real-time tracking

## Modification Guidelines

### Adding New Asset Types
1. Add to TRADING_HOURS configuration
2. Create data loader in load_data() function
3. Update get_latest_prices() for price retrieval
4. Modify apply_ta() for technical indicators
5. Update position sizing logic if needed

### Modifying Risk Parameters
1. Update RISK_PARAMS constants
2. Modify AdvancedRiskManager validation logic
3. Adjust position sizing calculations
4. Update circuit breaker thresholds

### Adding New Technical Indicators
1. Implement in apply_ta() function
2. Add to feature_columns in train_model_from_data()
3. Update get_latest_features() for prediction
4. Modify generate_signal() if using new indicators

### Changing Trading Strategy
1. Modify generate_signal() entry logic
2. Update TP/SL calculation methods
3. Adjust model training parameters
4. Modify risk validation thresholds

## Error Handling Architecture

- Circuit Breaker: Market-wide safety controls
- Risk Manager: Trade-level risk controls
- Data Validation: Input quality checks
- Emergency Stop: System-wide protection
- Health Monitoring: Continuous system validation

This architecture provides a robust foundation for automated trading with comprehensive risk management, real-time monitoring, and extensible design for future enhancements.